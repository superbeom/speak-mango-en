{
    "name": "Speak Mango (i18n + Verify Content + 6 items) v4 - Ïò§ÎîîÏò§ ÏÉùÏÑ± Í≤ÄÏ¶ù ÌïÑÏöî",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "*/5 * * * *"
                        }
                    ]
                }
            },
            "id": "12265455-f6d1-4c44-8c6a-242feadc1c18",
            "name": "Schedule Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.1,
            "position": [
                -688,
                -320
            ]
        },
        {
            "parameters": {
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                160,
                -480
            ],
            "id": "ffdd2f79-1d5d-40f2-bd41-bdaa06f50274",
            "name": "Google Gemini Chat Model",
            "credentials": {
                "googlePalmApi": {
                    "id": "your-gemini-api-id",
                    "name": "Google Gemini(PaLM) Api account"
                }
            }
        },
        {
            "parameters": {
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                1248,
                -128
            ],
            "id": "861c4c56-e53c-4821-89b4-9fb88b60d720",
            "name": "Google Gemini Chat Model1",
            "credentials": {
                "googlePalmApi": {
                    "id": "your-gemini-api-id",
                    "name": "Google Gemini(PaLM) Api account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Ï£ºÏ†ú Î™©Î°ù Ï†ïÏùò (ÎåÄÎ∂ÑÎ•ò/ÏÜåÎ∂ÑÎ•ò Ï≤¥Í≥Ñ Ï†ÅÏö©)\n// V2 Î≥ÄÍ≤ΩÏ†ê: ÎûúÎç§ ÏÑ†ÌÉù ÏóÜÏù¥ Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î∞òÌôòÌïòÏó¨ ÎèôÏãúÏóê Î≥ëÎ†¨ Ï≤òÎ¶¨Ìï©ÎãàÎã§.\nconst topics = [\n  {\n    domain: \"conversation\",\n    category: \"daily\",\n    topic: \"ÎØ∏Íµ≠ ÏõêÏñ¥ÎØºÏù¥ Îß§Ïùº Ïì∞Îäî ÏÉùÌôú ÏòÅÏñ¥ ÌëúÌòÑ\",\n  },\n  // {\n  //   domain: \"conversation\",\n  //   category: \"business\",\n  //   topic: \"ÎπÑÏ¶àÎãàÏä§ ÎØ∏ÌåÖÏù¥ÎÇò Ïù¥Î©îÏùºÏóêÏÑú Íº≠ ÌïÑÏöîÌïú Ï†ïÏ§ëÌïú ÏòÅÏñ¥ ÌëúÌòÑ\",\n  // },\n  {\n    domain: \"conversation\",\n    category: \"travel\",\n    topic: \"Ìï¥Ïô∏ Ïó¨ÌñâÌï† Îïå Ïú†Ïö©Ìïú ÌïÑÏàò ÏòÅÏñ¥ ÌëúÌòÑ\",\n  },\n  {\n    domain: \"conversation\",\n    category: \"shopping\",\n    topic: \"Ìï¥Ïô∏ ÏßÅÍµ¨ ÏáºÌïëÏù¥ÎÇò Îß§Ïû•ÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî ÏáºÌïë Í¥ÄÎ†® ÏòÅÏñ¥ ÌëúÌòÑ\",\n  },\n  {\n    domain: \"conversation\",\n    category: \"emotion\",\n    topic: \"Í∏∞ÏÅ®, Ïä¨Ìîî, ÌôîÎÇ® Îì± Í∞êÏ†ïÏùÑ ÏÑ¨ÏÑ∏ÌïòÍ≤å ÌëúÌòÑÌïòÎäî ÏòÅÏñ¥ Îã®Ïñ¥\",\n  },\n  {\n    domain: \"conversation\",\n    category: \"slang\",\n    topic: \"ÎØ∏ÎìúÎÇò ÏòÅÌôîÏóê ÏûêÏ£º ÎÇòÏò§Îäî ÏµúÏã† Ìä∏Î†åÎîîÌïú Ïä¨Îû≠\",\n  },\n];\n\n// Î™®Îì† Ï£ºÏ†úÎ•º ÏïÑÏù¥ÌÖúÏúºÎ°ú Î∞òÌôò (Fan-out)\nreturn topics.map(t => ({\n  json: {\n    domain: t.domain,\n    category: t.category,\n    topic: t.topic\n  }\n}));"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -512,
                -320
            ],
            "id": "62653a4d-bb7d-45b3-8638-299ed7765f78",
            "name": "Pick Category"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=Role: Professional English Teacher\nTask: Suggest ONE useful English expression related to the category below.\n\nDomain: {{ $json.domain }}\nCategory: {{ $json.category }}\n\n# EXCLUDED EXPRESSIONS (Do NOT generate these):\n{{ $json.existing_expressions_str }}\n\nRequirements:\n1. The expression must be practical and widely used.\n2. **Do NOT use any expression listed in the 'EXCLUDED EXPRESSIONS' list.**\n3. Capitalization for 'expression':\n   - Start with an UPPERCASE letter for standalone sentences (e.g., \"Don't take it personally\", \"No cap\").\n   - Start with a lowercase letter for general phrases or idioms (e.g., \"spill the tea\", \"hit the road\").\n4. Punctuation for 'expression': Do NOT include trailing periods (.) or commas (,). Exclamation marks (!) and question marks (?) are allowed.\n5. For the 'meaning' field:\n   - Provide a concise definition in a casual tone (Î∞òÎßê).\n   - If there are multiple meanings, separate them with ' ¬∑ ' (middle dot).\n   - Do NOT end with a period (.).\n6. Output MUST be a clean JSON object.\n\nOutput Format (JSON):\n{\n  \"expression\": \"Hold your horses\",\n  \"meaning\": \"Ïû†Íπê Í∏∞Îã§Î†§ ¬∑ ÏßÑÏ†ïÌï¥\"\n}",
                "batching": {}
            },
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.8,
            "position": [
                160,
                -320
            ],
            "id": "ab206104-864b-457d-b78d-ea52fdf3fe75",
            "name": "Gemini Expression Generator",
            "executeOnce": false
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "=Role: Professional English Content Creator & Polyglot Teacher.\nTask: Create a detailed study card for the following English expression in these languages: **English (en), Korean (ko), Japanese (ja), Spanish (es), French (fr), German (de), Russian (ru), Chinese (zh), and Arabic (ar)**.\n\nExpression: {{ $json.expression }}\nDomain: {{ $json.domain }}\nCategory: {{ $json.category }}\n\nRequirements:\n1. Tone: Friendly, humorous, and engaging (target audience: 20-30s), BUT **MUST use polite language consistently** for explanations.\n    - **English**: Use **Standard English** (Friendly, conversational, yet educational).\n    - **Korean**: Use **Ï°¥ÎåìÎßê (Jondaetmal)**.\n    - **Japanese**: Use **Desu-Masu Form (‰∏ÅÂØßË™û)**.\n    - **Spanish**: Use **'T√∫' form** but keep it respectful and professional.\n    - **French**: Use **'Tu' form** for engagement but maintain a polite, helpful tone (or 'Vous' if context demands strict formality, but 'Tu' is preferred for 20-30s friendly content).\n    - **German**: Use **'Du' form** (friendly, for 20-30s audience).\n    - **Russian**: Use **'–í—ã' (Polite)** for general explanations to maintain authority, or **'—Ç—ã'** if very casual. (Stick to **Friendly '–í—ã'** or respectful **'—Ç—ã'**). Let's use **Friendly '–¢—ã'** for this target audience (20-30s blog style).\n    - **Chinese**: Use **Polite yet friendly (‰Ω† + Êï¨ËØ≠/Polite particles)**.\n    - **Arabic**: Use **Modern Standard Arabic (MSA)** but with a friendly, accessible tone (avoid overly archaic vocabulary).\n\n2. For the 'meaning' field in ALL languages:\n   - **Tone**: Use a **casual tone** by default.\n     - **Korean**: Use **Î∞òÎßê (Banmal)**.\n     - **Japanese**: Use **Plain Form (Tameguchi/„Çø„É°Âè£)**.\n     - **Spanish**: Use **Informal 'T√∫' form**.\n     - **French**: Use **Informal 'Tu' form**.\n     - **German**: Use **Informal 'Du' form**.\n     - **Russian**: Use **Informal '—Ç—ã' form**.\n     - **Chinese**: Use **Casual speech**.\n     - **Arabic**: Use **MSA** (simplified).\n   - **Target Language ONLY**: Definitions must be in the specified Target Language. Do NOT mix with other languages (except for 'en', which uses English).\n   - **EXCEPTION**: If the English expression is formal or typically used in a polite situation (e.g., \"Could I...\", \"May I...\"), use a **polite tone** in all languages.\n     - **Korean**: Ï°¥ÎåìÎßê (Jondaetmal).\n     - **Japanese**: Desu-Masu Form (‰∏ÅÂØßË™û).\n     - **Spanish**: Formal 'Usted' form.\n     - **French**: Formal 'Vous' form.\n     - **German**: Formal 'Sie' form.\n     - **Russian**: Formal '–í—ã' form.\n     - **Chinese**: Polite speech (using 'ÊÇ®' instead of '‰Ω†').\n     - **Arabic**: Formal MSA (Fusha).\n   - For English (en) meaning: Provide a simple, clear definition or synonym in English.\n   - **Punctuation**: If the English expression is a question (?), the meaning MUST also end with a question mark (?) or be phrased as a question. Do NOT use trailing periods (.) for statements.\n   - If there are multiple meanings, separate them with ' ¬∑ ' (middle dot).\n3. Formatting for 'expression':\n   - **Capitalization**: **Start with an UPPERCASE letter** if the expression is a standalone sentence or interjection (e.g., \"No worries\", \"Never mind\", \"Don't take it personally\"). **Start with a lowercase letter** ONLY if it is a phrase or idiom used within a sentence (e.g., \"spill the tea\", \"hit the road\").\n   - Punctuation: Do NOT include trailing periods (.) or commas (,). Exclamation marks (!) and question marks (?) are allowed.\n4. Constraint for content:\n   - **Language Usage**: Use the specific **Target Language** for all explanations (this applies to situation, tips, AND quiz questions/options).\n     *   **English Inclusion Allowed**: You MAY include the English expression or specific English keywords naturally for educational purposes.\n     *   **No Mixed Target Language Scripts**: Do NOT mix in other target languages (e.g., no Japanese characters in Korean content, no Hangul in Spanish).\n   - **NEVER use casual speech** in the explanation, tips, dialogue, or situation description (except for the 'meaning' field).\n     - **English**: Avoid text-speak (e.g., \"u\", \"r\") or excessive slang in explanations; keep it clear and accessible.\n     - **Korean**: No Î∞òÎßê (Banmal).\n     - **Japanese**: No Plain Form (Tameguchi).\n     - **Spanish/French/German/Russian**: Maintain a helpful, teacher-like tone (avoid overly colloquial slang in the explanation text itself).\n   - Do NOT mix polite and casual styles. Keep the tone consistent throughout.\n   - Do NOT address the reader as specific groups like \"Kids\" or \"Students\". Use a general, relatable tone suitable for young adults.\n5. Output MUST be a valid JSON object matching the schema below.\n6. 'meaning' and 'content' fields must contain keys for **en, ko, ja, es, fr, de, ru, zh, ar**.\n7. **Dialogue & Roles (CRITICAL)**:\n   - The `dialogue` field is a **TOP-LEVEL array** (sibling to `meaning` and `content`), NOT inside `content`.\n   - Create a **coherent, natural conversation** between two people (A and B).\n   - **The dialogue MUST consist of 2 or 3 turns (A -> B or A -> B -> A).**\n   - Ensure natural interaction where either speaker can use the target expression in a meaningful context (not limited to a Q&A pattern).\n   - Each entry in the `dialogue` array MUST include:\n     - `\"role\"`: Value \"A\" or \"B\" to distinguish speakers.\n     - `\"en\"`: The English sentence (**English ONLY**).\n     - `\"translations\"`: **CRITICAL** An object containing translations for **ALL 8 target languages**: `\"ko\"`, `\"ja\"`, `\"es\"`, `\"fr\"`, `\"de\"`, `\"ru\"`, `\"zh\"`, `\"ar\"`.\n       *   **Do NOT omit this object or any languages.**\n       *   **Target Language ONLY**: The value MUST contain ONLY the translated text in the target language.\n       *   **Pure Text Only**: Do NOT use markdown formatting (e.g., **bold**, *italic*). **Natural punctuation** (e.g., . , ? ! ') IS allowed and expected to reflect the spoken tone.\n       *   **No Mixed Language (CRITICAL)**: **NEVER** include the original English text or the English expression in the translation. (e.g., **Bad**: \"ÏïàÎÖïÌïòÏÑ∏Ïöî. Hello.\", **Good**: \"ÏïàÎÖïÌïòÏÑ∏Ïöî\")\n8. **Consistency**: Use the 'Example (Korean)' below as a reference for the depth, humor, and style. Apply the same quality to English, Japanese, Spanish, French, German, Russian, Chinese, and Arabic.\n9. **Fixed Fields**: Include the 'domain' and 'category' exactly as provided in the input.\n10. **Quiz Logic (CRITICAL)**:\n    - The quiz must test the understanding of the English expression.\n    - **Randomly select one of the following patterns**:\n      - **Pattern 1 (Situation -> English)**: Describe a situation in [Target Language] and ask \"Which English expression fits this situation?\". -> The options (A, B, C) MUST be **English expressions**.\n        *   *Example (Target Language: ko)*: Q: \"ÏπúÍµ¨Í∞Ä \\\"Ïù¥Î≤à Ï£ºÎßêÏóê ÏòÅÌôî Î≥ºÍπåÏöî?\\\"ÎùºÍ≥† Ï†úÏïàÌñàÏùÑ Îïå, Í∏çÏ†ïÏ†ÅÏúºÎ°ú ÎèôÏùòÌïòÎäî Í∞ÄÏû• ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏòÅÏñ¥ ÌëúÌòÑÏùÄ?\\n\\nA. Sounds bad\\nB. Sounds good\\nC. Sounds angry\"\n      - **Pattern 2 (Expression -> Situation)**: Show the expression and ask \"When would you use this?\" in [Target Language]. -> The options (A, B, C) MUST be **situations described in [Target Language]**.\n        *   *Example (Target Language: ko)*: Q: \"Îã§Ïùå Ï§ë 'What's up?'ÏùÑ Í∞ÄÏû• ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÏÉÅÌô©ÏùÄ?\\n\\nA. üí∞ ÏùÄÌñâÏóêÏÑú ÎåÄÏ∂ú ÏÉÅÎã¥ÏùÑ Î∞õÍ≥† ÏûàÎã§.\\nB. üöÄ ÌöåÏÇ¨ Ï§ëÏó≠ ÌöåÏùòÏóêÏÑú Î∞úÌëúÎ•º ÏãúÏûëÌïúÎã§.\\nC. üö∂‚Äç‚ôÄÔ∏è Í∏∏ÏùÑ Í±∑Îã§Í∞Ä ÏπúÍµ¨ÏôÄ ÎààÏù¥ ÎßàÏ£ºÏ≥§Îã§.\"\n      - **Pattern 3 (Negative Logic)**: Ask \"Which situation is **NOT** appropriate for this expression?\" in [Target Language]. -> The options (A, B, C) MUST be **situations described in [Target Language]**.\n        *   *Example (Target Language: ko)*: Q: \"Îã§Ïùå Ï§ë 'Let's touch base.'Ïùò ÏÇ¨Ïö©Ïù¥ Ï†ÅÏ†àÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌô©ÏùÄ?\\n\\nA. üôã‚Äç‚ôÄÔ∏è ÌåÄÏõêÍ≥º Ï£ºÍ∞Ñ Î≥¥Í≥†ÏÑúÏóê ÎåÄÌï¥ ÏßßÍ≤å Ïù¥ÏïºÍ∏∞Ìï† Îïå.\\nB. ü•≥ ÏπúÍµ¨Îì§Í≥º Ï£ºÎßêÏóê ÎÜÄÎü¨ Í∞à Í≥ÑÌöçÏùÑ ÏÑ∏Ïö∏ Îïå.\\nC. üßë‚Äçüíª Í≥†Í∞ùÍ≥º Îã§Ïùå Îã®Í≥Ñ ÎÖºÏùòÎ•º ÏúÑÌï¥ Ïó∞ÎùΩÌï† Îïå.\"\n    - **Strict Formatting & Validation Rules**:\n      1. **These rules apply to ALL languages (en, ko, ja, es, fr, de, ru, zh, ar).**\n      2. You **MUST** provide 3 distinct options labeled A, B, and C.\n      3. You **MUST** use `\\n` (newline) to separate the question and each option.\n      4. The 'answer' field MUST be **only the uppercase letter** (e.g., \"A\", \"B\", \"C\"). **NEVER** include the full text of the answer.\n      5. **Randomize the correct answer position**: The correct answer MUST be randomly assigned to A, B, or C. Do NOT default to 'B'. ensure equal distribution of A, B, and C across different generations.\n11. **Tags (MANDATORY)**: Include a `\"tags\"` field containing an array of 3 to 5 lowercase **English** strings (**English ONLY**). These tags should be relevant keywords that help categorize the expression (e.g., \"idiom\", \"office\", \"slang\", \"travel\"). Do NOT include the '#' symbol.\n12. **Currency & Numbers**:\n    - Always use **`$` (USD)** for currency to maintain consistency (e.g., \"$10\", \"$50.50\"). Do not use other currencies like 'won', 'yen', or 'euro' unless the expression specifically requires it.\n    - Use commas for numbers larger than 1,000 (e.g., \"1,000\", \"10,000\").\n\nExample Output (Reference this style for ALL languages):\n{\n  \"expression\": \"under the weather\",\n  \"domain\": \"conversation\",\n  \"category\": \"daily\",\n  \"meaning\": {\n    \"en\": \"not feeling well ¬∑ feeling sick\",\n    \"ko\": \"Î™∏Ïù¥ Ï¢Ä Ïïà Ï¢ãÏïÑ ¬∑ Ïª®ÎîîÏÖòÏù¥ Î≥ÑÎ°úÏïº\",\n    \"ja\": \"‰ΩìË™ø„ÅåÂ∞ë„ÅóÊÇ™„ÅÑ ¬∑ Ê∞óÂàÜ„Åå„Åô„Åê„Çå„Å™„ÅÑ\",\n    \"es\": \"sentirse un poco mal ¬∑ no estar al cien\",\n    \"fr\": \"se sentir mal ¬∑ √™tre patraque\",\n    \"de\": \"sich nicht gut f√ºhlen ¬∑ angeschlagen sein\",\n    \"ru\": \"–Ω–µ–≤–∞–∂–Ω–æ —Å–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å ¬∑ –ø—Ä–∏–±–æ–ª–µ—Ç—å\",\n    \"zh\": \"Ë∫´‰Ωì‰∏çËàíÊúç ¬∑ ÊÑüËßâ‰∏çÂ§™Â•Ω\",\n    \"ar\": \"ŸÑÿ≥ÿ™ ÿπŸÑŸâ ŸÖÿß Ÿäÿ±ÿßŸÖ ¬∑ ÿ£ÿ¥ÿπÿ± ÿ®ÿßŸÑŸÖÿ±ÿ∂\"\n  },\n  \"content\": {\n    \"en\": {\n      \"situation\": \"This is perfect for those days when you wake up feeling a bit sluggish or off. üò± It's a great expression to say you're not 100%, but not seriously ill either! ü§í‚ú®\",\n      \"tip\": \"üí° **Fun Fact!** This idiom is said to come from sailors who would go below deck (under the weather rail) when they felt seasick during bad weather! ‚öìÔ∏èüåä Remember, if you are genuinely sick, it's better to say 'I'm sick' or 'I have a fever'.\",\n      \"quiz\": {\n        \"question\": \"When is the most appropriate time to use 'under the weather'?\\n\\nA. ü•≥ When you are dancing happily at a party.\\nB. üò¥ When you are lying in bed feeling a bit chilly and off.\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è When you are lifting weights energetically at the gym.\",\n        \"answer\": \"B\"\n      }\n    },\n    \"ko\": {\n      \"situation\": \"üåü ÏïÑÏπ®Ïóê ÏùºÏñ¥ÎÇ¨ÎäîÎç∞ Ïô†ÏßÄ Î™®Î•¥Í≤å Î™∏Ïù¥ Ï∂ï Ï≤òÏßÄÍ≥†, Ïª®ÎîîÏÖòÏù¥ Î≥ÑÎ°úÏùº Îïå! üò± 'ÏïÑ, ÎÇò Ïò§Îäò Î≠îÍ∞Ä Ï¢Ä Î≥ÑÎ°†Îç∞... Î≥ëÎì† Î≥ëÏïÑÎ¶¨ Í∞ôÏïÑ...' Ìï† Îïå Ïì∞Îäî ÌïµÏù∏Ïã∏ ÌëúÌòÑÏù¥ÏóêÏöî! ÏßÑÏßú ÏïÑÌîà Í±¥ ÏïÑÎãåÎç∞ Í∑∏Î†áÎã§Í≥† ÏôÑÏ†Ñ Ïå©Ïå©ÌïòÏßÄÎèÑ ÏïäÏùÑ Îïå, Í∞ÄÎ≥çÍ≤å ÎÇ¥ ÏÉÅÌÉúÎ•º ÎßêÌïòÍ≥† Ïã∂ÏùÑ Îïå Ï∞∞Îñ°Í∞ôÏù¥ Ïì∏ Ïàò ÏûàÎãµÎãàÎã§! ü§í‚ú®\",\n      \"tip\": \"üö® **ÍøÄÌåÅ Î∞©Ï∂ú!** 'under the weather'Îäî ÏßÑÏßú Ïã¨Í∞ÅÌïòÍ≤å ÏïÑÌîå ÎïåÎ≥¥Îã§Îäî Í∞ÄÎ≥çÍ≤å 'Ïª®ÎîîÏÖòÏù¥ Ïïà Ï¢ãÎã§', 'Í∞êÍ∏∞ Í∏∞Ïö¥Ïù¥ ÏûàÎã§' Ï†ïÎèÑÏùò ÎäêÎÇåÏù¥ÏóêÏöî. üò∑ ÎßåÏïΩ ÏßÑÏßú Ïã¨ÌïòÍ≤å ÏïÑÌîÑÎã§Î©¥ 'I'm sick' ÎòêÎäî 'I have a fever'Ï≤òÎüº Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÎßêÌïòÎäî Í≤å Ï¢ãÏïÑÏöî. üòâ Í∑∏Î¶¨Í≥† Ïù¥ ÌëúÌòÑÏùÄ Î±ÉÏÇ¨ÎûåÎì§Ïù¥ Î∞∞ÏóêÏÑú ÎÇ†Ïî®Í∞Ä Ïïà Ï¢ãÏùÑ Îïå ÏïÑÌîà ÏÇ¨ÎûåÏùÑ Í∞ëÌåê ÏïÑÎûòÎ°ú Î≥¥ÎÇ¥ 'ÎÇ†Ïî® ÏïÑÎûò'Ïóê ÏûàÍ≤å ÌñàÎã§Îäî Ïú†ÎûòÍ∞Ä ÏûàÎåÄÏöî! ÏôÑÏ†Ñ Ïã†Í∏∞ÌïòÏ£†? ‚öìÔ∏èüåä\",\n      \"quiz\": {\n        \"question\": \"Îã§Ïùå Ï§ë 'under the weather'Î•º ÏÇ¨Ïö©ÌïòÍ∏∞ Í∞ÄÏû• Ï†ÅÏ†àÌïú ÏÉÅÌô©ÏùÄ?\\n\\nA. ü•≥ ÌååÌã∞ÏóêÏÑú Ïã†ÎÇòÍ≤å Ï∂§Ï∂îÍ≥† ÏûàÎã§.\\nB. üò¥ Ïπ®ÎåÄÏóêÏÑú Î∞çÍ∏∞Ï†ÅÍ±∞Î¶¨Î©∞ Î™∏Ïù¥ Ï¢Ä ÏúºÏä¨ÏúºÏä¨ÌïòÎã§.\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è Ìó¨Ïä§Ïû•ÏóêÏÑú Ïó≠Í∏∞Î•º Îì§Í≥† Ïö¥ÎèôÌïòÍ≥† ÏûàÎã§.\",\n        \"answer\": \"B\"\n      }\n    },\n    \"ja\": {\n      \"situation\": \"ÊúùËµ∑„Åç„ÅüÊôÇ„Å´„ÄÅ„Å™„Çì„Å®„Å™„Åè‰Ωì„Åå„Å†„Çã„Åè„Å¶„Äå‰ªäÊó•„ÅØ„Å™„Çì„Å†„ÅãË™øÂ≠ê„ÅåÊÇ™„ÅÑ„Å™‚Ä¶„Äç„Å®ÊÑü„Åò„ÇãÊôÇ„Å´„Å¥„Å£„Åü„Çä„ÅÆË°®Áèæ„Åß„ÅôÔºÅüò∑ Êú¨ÂΩì„Å´„Å≤„Å©„ÅÑÁóÖÊ∞ó„Åß„ÅØ„Å™„ÅÑ„Åë„Çå„Å©„ÄÅ100%ÂÖÉÊ∞ó„Åß„ÇÇ„Å™„ÅÑÊôÇ„Å´„ÄÅËá™ÂàÜ„ÅÆÁä∂ÊÖã„Çí„Ç´„Ç∏„É•„Ç¢„É´„Å´‰ºù„Åà„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ‚ú®\",\n      \"tip\": \"üí° **Ë±ÜÁü•Ë≠ò!** „Åì„ÅÆË°®Áèæ„ÅØ„ÄÅÊòî„ÅÆËàπ‰πó„Çä„ÅåÂ§©ÂÄô„ÅåÊÇ™„Åè„Å¶‰ΩìË™ø„ÇíÂ¥©„Åó„ÅüÊôÇ„Å´„ÄÅÁî≤Êùø„ÅÆ‰∏ãÔºàUnder the deckÔºâ„Å´ÈÅøÈõ£„Åó„Åü„Åì„Å®„Åã„Çâ„ÄåUnder the weather„Äç„Å´„Å™„Å£„Åü„Å®„ÅÑ„ÅÜË™¨„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ‚öìÔ∏è Êú¨ÂΩì„Å´‰ΩìË™ø„ÅåÊÇ™„ÅÑÊôÇ„ÅØ„ÄåI'm sick„Äç„Çí‰Ωø„ÅÑ„Åæ„Åó„Çá„ÅÜÔºÅ\",\n      \"quiz\": {\n        \"question\": \"„Äåunder the weather„Äç„Çí‰Ωø„ÅÜ„ÅÆ„Å´ÊúÄ„ÇÇÈÅ©„Åó„ÅüÁä∂Ê≥Å„ÅØÔºü\\n\\nA. ü•≥ „Éë„Éº„ÉÜ„Ç£„Éº„ÅßÊ•Ω„Åó„ÅèË∏ä„Å£„Å¶„ÅÑ„Çã„ÄÇ\\nB. üò¥ È¢®ÈÇ™Ê∞óÂë≥„Åß„ÄÅ„Éô„ÉÉ„Éâ„Åß‰ºë„Çì„Åß„ÅÑ„Çã„ÄÇ\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è „Ç∏„É†„ÅßÂÖÉÊ∞ó„Å´„Éà„É¨„Éº„Éã„É≥„Ç∞„Åó„Å¶„ÅÑ„Çã„ÄÇ\",\n        \"answer\": \"B\"\n      }\n    },\n    \"es\": {\n      \"situation\": \"¬°Cuando te despiertas y te sientes un poco cansado o sin energ√≠a! üò± Es una expresi√≥n muy com√∫n para decir que no te sientes al 100%, pero tampoco est√°s gravemente enfermo. ü§í‚ú®\",\n      \"tip\": \"üö® **¬°Dato curioso!** El origen viene de los marineros. Cuando el clima era malo y se sent√≠an mal, bajaban debajo de la cubierta para estar 'bajo el clima'. üåä‚öìÔ∏è Si est√°s realmente enfermo, es mejor usar 'I'm sick'.\",\n      \"quiz\": {\n        \"question\": \"¬øEn qu√© situaci√≥n usar√≠as \\\"under the weather\\\"?\\n\\nA. ü•≥ En una fiesta bailando alegremente.\\nB. üò¥ Descansando en la cama porque te sientes un poco mal.\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è Entrenando con mucha energ√≠a en el gimnasio.\",\n        \"answer\": \"B\"\n      }\n    },\n    \"fr\": {\n      \"situation\": \"C'est parfait pour les jours o√π vous vous r√©veillez un peu mou. üò± C'est une super expression pour dire que vous n'√™tes pas √† 100%, sans √™tre gravement malade ! ü§í‚ú®\",\n      \"tip\": \"üí° **Le saviez-vous ?** Cette expression viendrait des marins qui descendaient sous le pont pour s'abriter du mauvais temps quand ils avaient le mal de mer ! ‚öìÔ∏èüåä\",\n      \"quiz\": {\n        \"question\": \"Quand est-il le plus appropri√© d'utiliser 'under the weather' ?\\n\\nA. ü•≥ Quand vous dansez joyeusement √† une f√™te.\\nB. üò¥ Quand vous √™tes au lit et que vous vous sentez un peu f√©brile.\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è Quand vous soulevez des poids √©nergiquement √† la salle de sport.\",\n        \"answer\": \"B\"\n      }\n    },\n    \"de\": {\n      \"situation\": \"Perfekt f√ºr Tage, an denen man aufwacht und sich einfach schlapp f√ºhlt. üò± Ein toller Ausdruck, um zu sagen, dass man nicht 100% fit ist, aber auch nicht ernsthaft krank! ü§í‚ú®\",\n      \"tip\": \"üí° **Schon gewusst?** Diese Redewendung stammt angeblich von Seeleuten, die bei schlechtem Wetter unter Deck gingen, wenn sie seekrank waren! ‚öìÔ∏èüåä\",\n      \"quiz\": {\n        \"question\": \"Wann ist der beste Zeitpunkt, 'under the weather' zu verwenden?\\n\\nA. ü•≥ Wenn du fr√∂hlich auf einer Party tanzt.\\nB. üò¥ Wenn du im Bett liegst und dich etwas kr√§nklich f√ºhlst.\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è Wenn du im Fitnessstudio energiegeladen Gewichte hebst.\",\n        \"answer\": \"B\"\n      }\n    },\n    \"ru\": {\n      \"situation\": \"–≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ—Ö –¥–Ω–µ–π, –∫–æ–≥–¥–∞ –≤—ã –ø—Ä–æ—Å—ã–ø–∞–µ—Ç–µ—Å—å —Å —á—É–≤—Å—Ç–≤–æ–º –≤—è–ª–æ—Å—Ç–∏. üò± –û—Ç–ª–∏—á–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –≤—ã –Ω–µ –Ω–∞ 100% –≤ —Ñ–æ—Ä–º–µ, –Ω–æ –∏ –Ω–µ —Å–µ—Ä—å–µ–∑–Ω–æ –±–æ–ª—å–Ω—ã! ü§í‚ú®\",\n      \"tip\": \"üí° **–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç!** –ì–æ–≤–æ—Ä—è—Ç, —á—Ç–æ —ç—Ç–∞ –∏–¥–∏–æ–º–∞ –ø–æ—à–ª–∞ –æ—Ç –º–æ—Ä—è–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–ø—É—Å–∫–∞–ª–∏—Å—å –ø–æ–¥ –ø–∞–ª—É–±—É (under the weather rail), –∫–æ–≥–¥–∞ –∏—Ö —É–∫–∞—á–∏–≤–∞–ª–æ –≤–æ –≤—Ä–µ–º—è —à—Ç–æ—Ä–º–∞! ‚öìÔ∏èüåä\",\n      \"quiz\": {\n        \"question\": \"–ö–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–µ–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 'under the weather'?\\n\\nA. ü•≥ –ö–æ–≥–¥–∞ –≤—ã —Ä–∞–¥–æ—Å—Ç–Ω–æ —Ç–∞–Ω—Ü—É–µ—Ç–µ –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–µ.\\nB. üò¥ –ö–æ–≥–¥–∞ –≤—ã –ª–µ–∂–∏—Ç–µ –≤ –∫—Ä–æ–≤–∞—Ç–∏ –∏ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–µ–≥–∫–æ–µ –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–µ.\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è –ö–æ–≥–¥–∞ –≤—ã —ç–Ω–µ—Ä–≥–∏—á–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç–µ —Ç—è–∂–µ—Å—Ç–∏ –≤ —Å–ø–æ—Ä—Ç–∑–∞–ª–µ.\",\n        \"answer\": \"B\"\n      }\n    },\n    \"zh\": {\n      \"situation\": \"ÂΩì‰Ω†Êó©‰∏äÈÜíÊù•ÊÑüËßâÊúâÁÇπÊ≤°Á≤æÁ•ûÊàñËÄÖ‰∏çËàíÊúçÁöÑÊó∂ÂÄôÔºåÁî®Ëøô‰∏™ËØçÂÜçÂêàÈÄÇ‰∏çËøá‰∫ÜÔºÅüò± ËøôÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑË°®ËææÔºåÁî®Êù•ÂΩ¢ÂÆπ‰Ω†Áä∂ÊÄÅ‰∏çÊòØ100%Â•ΩÔºå‰ΩÜ‰πüÊ≤°Áîü‰ªÄ‰πàÂ§ßÁóÖÔºÅü§í‚ú®\",\n      \"tip\": \"üí° **ÂÜ∑Áü•ËØÜÔºÅ** ÊçÆËØ¥ËøôÂè•‰π†ËØ≠Ê∫ê‰∫éÊ∞¥ÊâãÔºåÂΩìÈÅáÂà∞ÊÅ∂Âä£Â§©Ê∞îÊÑüÂà∞ÊôïËàπÊó∂Ôºå‰ªñ‰ª¨‰ºöË∫≤Âà∞Áî≤Êùø‰∏ãÈù¢Ôºàunder the weather railÔºâÔºÅ‚öìÔ∏èüåä\",\n      \"quiz\": {\n        \"question\": \"‰ªÄ‰πàÊó∂ÂÄôÊúÄÈÄÇÂêà‰ΩøÁî® 'under the weather'Ôºü\\n\\nA. ü•≥ ÂΩì‰Ω†Âú®Ê¥æÂØπ‰∏äÂºÄÂøÉÂú∞Ë∑≥ËàûÊó∂„ÄÇ\\nB. üò¥ ÂΩì‰Ω†Ë∫∫Âú®Â∫ä‰∏äÊÑüËßâÊúâÁÇπÂèëÂÜ∑‰∏çËàíÊúçÊó∂„ÄÇ\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è ÂΩì‰Ω†Âú®ÂÅ•Ë∫´ÊàøÁ≤æÂäõÂÖÖÊ≤õÂú∞‰∏æÈáçÊó∂„ÄÇ\",\n        \"answer\": \"B\"\n      }\n    },\n    \"ar\": {\n      \"situation\": \"Ÿáÿ∞ÿß ÿßŸÑÿ™ÿπÿ®Ÿäÿ± ŸÖÿ´ÿßŸÑŸä ŸÑŸÑÿ£ŸäÿßŸÖ ÿßŸÑÿ™Ÿä ÿ™ÿ≥ÿ™ŸäŸÇÿ∏ ŸÅŸäŸáÿß Ÿàÿ£ŸÜÿ™ ÿ™ÿ¥ÿπÿ± ÿ®ÿ®ÿπÿ∂ ÿßŸÑÿÆŸÖŸàŸÑ ÿ£Ÿà ÿßŸÑÿ™ÿπÿ®. üò± ÿ•ŸÜŸá ÿ™ÿπÿ®Ÿäÿ± ÿ±ÿßÿ¶ÿπ ŸÑÿ™ŸÇŸàŸÑ ÿ•ŸÜŸÉ ŸÑÿ≥ÿ™ ŸÅŸä ŸÉÿßŸÖŸÑ ŸÑŸäÿßŸÇÿ™ŸÉÿå ŸÑŸÉŸÜŸÉ ŸÑÿ≥ÿ™ ŸÖÿ±Ÿäÿ∂ÿßŸã ÿ®ÿ¥ŸÉŸÑ ÿÆÿ∑Ÿäÿ± ÿ£Ÿäÿ∂ÿßŸã! ü§í‚ú®\",\n      \"tip\": \"üí° **ÿ≠ŸÇŸäŸÇÿ© ŸÖŸÖÿ™ÿπÿ©!** ŸäŸÇÿßŸÑ ÿ•ŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÖÿµÿ∑ŸÑÿ≠ ÿ¨ÿßÿ° ŸÖŸÜ ÿßŸÑÿ®ÿ≠ÿßÿ±ÿ© ÿßŸÑÿ∞ŸäŸÜ ŸÉÿßŸÜŸàÿß ŸäŸÜÿ≤ŸÑŸàŸÜ ÿ™ÿ≠ÿ™ ÿ≥ÿ∑ÿ≠ ÿßŸÑÿ≥ŸÅŸäŸÜÿ© (ÿ™ÿ≠ÿ™ ÿ≠ÿßÿ¨ÿ≤ ÿßŸÑÿ∑ŸÇÿ≥) ÿπŸÜÿØŸÖÿß Ÿäÿ¥ÿπÿ±ŸàŸÜ ÿ®ÿØŸàÿßÿ± ÿßŸÑÿ®ÿ≠ÿ± ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ∑ŸÇÿ≥ ÿßŸÑÿ≥Ÿäÿ¶! ‚öìÔ∏èüåä\",\n      \"quiz\": {\n        \"question\": \"ŸÖÿ™Ÿâ ŸäŸÉŸàŸÜ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ£ŸÜÿ≥ÿ® ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿπÿ®ÿßÿ±ÿ© 'under the weather'ÿü\\n\\nA. ü•≥ ÿπŸÜÿØŸÖÿß ÿ™ÿ±ŸÇÿµ ÿ®ÿ≥ÿπÿßÿØÿ© ŸÅŸä ÿ≠ŸÅŸÑÿ©.\\nB. üò¥ ÿπŸÜÿØŸÖÿß ÿ™ŸÉŸàŸÜ ŸÖÿ≥ÿ™ŸÑŸÇŸäÿßŸã ŸÅŸä ÿßŸÑÿ≥ÿ±Ÿäÿ± Ÿàÿ™ÿ¥ÿπÿ± ÿ®ÿ®ÿπÿ∂ ÿßŸÑÿ®ÿ±ŸàÿØÿ© ŸàÿßŸÑÿ™ŸàÿπŸÉ.\\nC. üèãÔ∏è‚Äç‚ôÄÔ∏è ÿπŸÜÿØŸÖÿß ÿ™ÿ±ŸÅÿπ ÿßŸÑÿ£ÿ´ŸÇÿßŸÑ ÿ®ŸÜÿ¥ÿßÿ∑ ŸÅŸä ÿµÿßŸÑÿ© ÿßŸÑÿ£ŸÑÿπÿßÿ® ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ©.\",\n        \"answer\": \"B\"\n      }\n    }\n  },\n  \"dialogue\": [\n    {\n      \"role\": \"A\",\n      \"en\": \"Hey, you look a bit down. Are you okay?\",\n      \"translations\": {\n        \"ko\": \"Ï†ÄÍ∏∞, Ï¢Ä Í∏∞Î∂ÑÏù¥ Ïïà Ï¢ãÏïÑ Î≥¥Ïù¥ÎäîÎç∞. Í¥úÏ∞ÆÏïÑÏöî?\",\n        \"ja\": \"„Å≠„Åà„ÄÅ„Å™„Çì„Å†„ÅãÂÖÉÊ∞ó„Åå„Å™„ÅÑ„Åø„Åü„ÅÑ„Å†„Åë„Å©Â§ß‰∏àÂ§´Ôºü\",\n        \"es\": \"Oye, te ves un poco desanimado. ¬øEst√°s bien?\",\n        \"fr\": \"H√©, tu as l'air un peu d√©prim√©. √áa va ?\",\n        \"de\": \"Hey, du siehst ein bisschen niedergeschlagen aus. Alles okay?\",\n        \"ru\": \"–≠–π, —Ç—ã –≤—ã–≥–ª—è–¥–∏—à—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–º. –¢—ã –≤ –ø–æ—Ä—è–¥–∫–µ?\",\n        \"zh\": \"ÂòøÔºå‰Ω†ÁúãËµ∑Êù•ÊúâÁÇπÊ≤Æ‰∏ß„ÄÇ‰Ω†ËøòÂ•ΩÂêóÔºü\",\n        \"ar\": \"ŸÖŸáŸÑÿßŸãÿå ÿ™ÿ®ÿØŸà ŸÖÿ≠ÿ®ÿ∑ÿßŸã ŸÇŸÑŸäŸÑÿßŸã. ŸáŸÑ ÿ£ŸÜÿ™ ÿ®ÿÆŸäÿ±ÿü\"\n      }\n    },\n    {\n      \"role\": \"B\",\n      \"en\": \"I'm feeling a bit under the weather today, so I think I'll just head home early.\",\n      \"translations\": {\n        \"ko\": \"Ïò§Îäò Î™∏Ïù¥ Ï¢Ä Ïïà Ï¢ãÏïÑÏÑú, ÏùºÏ∞ç ÏßëÏóê Í∞ÄÎ†§Í≥†Ïöî.\",\n        \"ja\": \"‰ªäÊó•„ÅØ„Å°„Çá„Å£„Å®‰ΩìË™ø„ÅåÊÇ™„ÅÑ„ÅÆ„Åß„ÄÅÊó©„ÇÅ„Å´Â∏∞„Çç„ÅÜ„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ\",\n        \"es\": \"Hoy me siento un poco mal, as√≠ que creo que me ir√© a casa temprano.\",\n        \"fr\": \"Je ne me sens pas tr√®s bien aujourd'hui, donc je pense que je vais rentrer plus t√¥t.\",\n        \"de\": \"Ich f√ºhle mich heute etwas angeschlagen, deshalb werde ich wohl fr√ºher nach Hause gehen.\",\n        \"ru\": \"–Ø —Å–µ–≥–æ–¥–Ω—è –Ω–µ–≤–∞–∂–Ω–æ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É—é, –ø–æ—ç—Ç–æ–º—É –¥—É–º–∞—é –ø–æ–π—Ç–∏ –¥–æ–º–æ–π –ø–æ—Ä–∞–Ω—å—à–µ.\",\n        \"zh\": \"Êàë‰ªäÂ§©Ë∫´‰ΩìÊúâÁÇπ‰∏çËàíÊúçÔºåÊÉ≥Êó©ÁÇπÂõûÂÆ∂„ÄÇ\",\n        \"ar\": \"ÿ£ÿ¥ÿπÿ± ÿ®ÿ™ŸàÿπŸÉ ŸÇŸÑŸäŸÑ ÿßŸÑŸäŸàŸÖÿå ŸÑÿ∞ÿß ÿ≥ÿ£ÿπŸàÿØ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ≤ŸÑ ŸÖÿ®ŸÉÿ±ÿßŸã.\"\n      }\n    }\n  ],\n  \"tags\": [\"daily\", \"health\", \"lifestyle\"]\n}",
                "batching": {}
            },
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.8,
            "position": [
                1248,
                -304
            ],
            "id": "8b7fb4ee-64b0-4d2e-912f-471e43291542",
            "name": "Gemini Content Generator"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "speak_mango_en",
                "operation": "getAll",
                "tableId": "expressions",
                "limit": 1,
                "filters": {
                    "conditions": [
                        {
                            "keyName": "expression",
                            "condition": "ilike",
                            "keyValue": "=\"*{{ $json.expression }}*\""
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                416,
                224
            ],
            "id": "3537da0e-42a7-4194-b996-3e1a13790f8a",
            "name": "Check Duplicate",
            "alwaysOutputData": true,
            "credentials": {
                "supabaseApi": {
                    "id": "your-supabase-api-id",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 3
                    },
                    "conditions": [
                        {
                            "id": "7588390d-2c9b-4409-9df3-6e365605d4a6",
                            "leftValue": "={{ $json.id }}",
                            "rightValue": 0,
                            "operator": {
                                "type": "string",
                                "operation": "empty",
                                "singleValue": true
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.3,
            "position": [
                832,
                0
            ],
            "id": "319540e2-a3dc-4334-adf8-07098432ac46",
            "name": "If New"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "speak_mango_en",
                "tableId": "expressions",
                "dataToSend": "autoMapInputData"
            },
            "id": "3b71652d-c326-44bf-b5a6-1d8285f76e00",
            "name": "Supabase Insert",
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                2752,
                -304
            ],
            "credentials": {
                "supabaseApi": {
                    "id": "your-supabase-api-id",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// 06. Parse Expression JSON & Merge Context (V2 Robust)\n// Gemini Expression GeneratorÏùò ÏùëÎãµ(ÌÖçÏä§Ìä∏)ÏùÑ ÌååÏã±Ìï©ÎãàÎã§.\n// 'Merge Context' ÎÖ∏ÎìúÍ∞Ä ÏïûÎã®Ïóê Ï∂îÍ∞ÄÎêòÏñ¥, domain/category Ï†ïÎ≥¥Í∞Ä Ïù¥ÎØ∏ $inputÏóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎã§Í≥† Í∞ÄÏ†ïÌï©ÎãàÎã§.\n\nreturn $input.all().map((item) => {\n    const rawText = item.json.text || \"\";\n\n    // Clean Markdown\n    const cleanJson = rawText\n        .replace(/^```json\\s*/i, \"\")\n        .replace(/\\s*```$/, \"\")\n        .trim();\n\n    // Context: Merge NodeÎ•º ÌÜµÌï¥ Ïù¥ÎØ∏ jsonÏóê Ìï©Ï≥êÏ†∏ ÏûàÏùå\n    const domain = item.json.domain || \"unknown\";\n    const category = item.json.category || \"unknown\";\n    const topic = item.json.topic || \"unknown\";\n\n    try {\n        const parsed = JSON.parse(cleanJson);\n        return {\n            json: {\n                ...parsed,\n                domain,\n                category,\n                topic\n            },\n            pairedItem: item.pairedItem\n        };\n    } catch (error) {\n        return {\n            json: {\n                error: \"JSON Parsing Failed\",\n                message: error.message,\n                raw: rawText,\n                domain,\n                category,\n                topic\n            },\n            pairedItem: item.pairedItem\n        };\n    }\n});"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                416,
                0
            ],
            "id": "6612b271-4616-4059-8ee2-f7ec0524505c",
            "name": "Parse Expression JSON"
        },
        {
            "parameters": {
                "jsCode": "// 11. Parse Content JSON\n// Gemini Content GeneratorÏùò ÏùëÎãµ(ÌÖçÏä§Ìä∏)ÏùÑ ÌååÏã±ÌïòÏó¨ JSON Í∞ùÏ≤¥Î°ú Î≥ÄÌôòÌï©ÎãàÎã§.\n// Î≥ëÎ†¨ Ïã§Ìñâ(Fan-out)ÏùÑ ÏßÄÏõêÌïòÍ∏∞ ÏúÑÌï¥ Îì§Ïñ¥Ïò§Îäî Î™®Îì† ÏïÑÏù¥ÌÖú($input.all())ÏùÑ Ï≤òÎ¶¨Ìï©ÎãàÎã§.\n\nreturn $input.all().map(item => {\n    const rawText = item.json.text;\n\n    // 1. ÌÖçÏä§Ìä∏Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏóêÎü¨ Ï≤òÎ¶¨\n    if (!rawText) {\n        return {\n            json: {\n                error: \"No text field found\",\n                ...item.json // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥ ÏãúÎèÑ\n            },\n            pairedItem: item.pairedItem\n        };\n    }\n\n    // 2. ÎßàÌÅ¨Îã§Ïö¥ ÏΩîÎìú Î∏îÎ°ù(```json ... ```) ÏïàÏ†ÑÌïòÍ≤å Ï†úÍ±∞\n    // Ï†ïÍ∑úÏãùÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÏïûÎí§Ïùò ÎßàÌÅ¨Îã§Ïö¥ ÌÉúÍ∑∏Îßå Ï†úÍ±∞ÌïòÍ≥† ÎÇ¥Ïö©Î¨ºÏùÄ Ïú†ÏßÄÌï©ÎãàÎã§.\n    const cleanJson = rawText\n        .replace(/^```json\\s*/i, \"\") // ÏãúÏûë ÌÉúÍ∑∏ (case insensitive)\n        .replace(/\\s*```$/, \"\")      // Ï¢ÖÎ£å ÌÉúÍ∑∏\n        .trim();\n\n    try {\n        // 3. JSON ÌååÏã±\n        const parsed = JSON.parse(cleanJson);\n\n        return {\n            json: parsed,\n            pairedItem: item.pairedItem // Lineage Ïú†ÏßÄ\n        };\n    } catch (error) {\n        // 4. ÌååÏã± Ïã§Ìå® Ïãú ÏóêÎü¨ Î°úÍ∑∏ Î∞òÌôò (ÎîîÎ≤ÑÍπÖÏö©)\n        return {\n            json: {\n                error: \"JSON Parsing Failed\",\n                message: error.message,\n                raw: rawText,\n                clean: cleanJson\n            },\n            pairedItem: item.pairedItem\n        };\n    }\n});"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1584,
                -304
            ],
            "id": "e2e41e65-58f2-4677-86b9-2de999fcf3fb",
            "name": "Parse Content JSON"
        },
        {
            "parameters": {
                "useCustomSchema": true,
                "schema": "speak_mango_en",
                "operation": "getAll",
                "tableId": "expressions",
                "returnAll": true,
                "matchType": "allFilters",
                "filters": {
                    "conditions": [
                        {
                            "keyName": "category",
                            "condition": "eq",
                            "keyValue": "={{ $('Pick Category').item.json.category }}"
                        }
                    ]
                }
            },
            "type": "n8n-nodes-base.supabase",
            "typeVersion": 1,
            "position": [
                -336,
                -320
            ],
            "id": "bfe99e67-48e4-49c5-a53d-e597deac405a",
            "name": "Get Existing Expressions",
            "alwaysOutputData": false,
            "executeOnce": false,
            "retryOnFail": false,
            "notesInFlow": false,
            "credentials": {
                "supabaseApi": {
                    "id": "your-supabase-api-id",
                    "name": "Supabase account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// 13. Generate ID (V2 Fan-out Support)\n// Ï§ëÎ≥µÏù¥ ÏïÑÎãòÏù¥ ÌôïÏù∏Îêú Í∞Å ÏïÑÏù¥ÌÖúÏóê ÎåÄÌï¥ Ï†ÄÏû• Í≤ΩÎ°ú Î∞è DB IDÎ°ú ÏÇ¨Ïö©Ìï† UUIDÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.\n// V2 Î≥ÄÍ≤ΩÏ†ê: $input.all()ÏùÑ ÏàúÌöåÌïòÎ©∞ Î™®Îì† ÏïÑÏù¥ÌÖúÏóê ÎåÄÌï¥ Í∞ÅÍ∞ÅÏùò UUIDÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.\n\nreturn $input.all().map(item => {\n    // UUID v4 ÏÉùÏÑ± (crypto Î™®Îìà ÏùòÏ°¥ÏÑ± ÏóÜÏù¥)\n    const uuid = \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(\n        /[xy]/g,\n        function (c) {\n            const r = (Math.random() * 16) | 0;\n            const v = c === \"x\" ? r : (r & 0x3) | 0x8;\n            return v.toString(16);\n        }\n    );\n\n    return {\n        json: {\n            ...item.json, // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥\n            id: uuid,     // Í≥†Ïú† ID Î∂ÄÏó¨\n        },\n        pairedItem: item.pairedItem // Lineage Ïú†ÏßÄ\n    };\n});"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1920,
                -304
            ],
            "id": "5e515074-f53c-4ec1-934f-fe3b9a9308a5",
            "name": "Generate ID"
        },
        {
            "parameters": {
                "jsCode": "// 14. Prepare TTS Requests (V2 Fan-out Support)\n// ÎåÄÌôîÎ¨∏Ïùò Ïó≠Ìï†(A, B)Ïóê Îî∞Îùº ÏïÑÏù¥ÌÖúÏùÑ Î∂ÑÎ¶¨ÌïòÍ≥† Í∞ÅÍ∞Å Î™©ÏÜåÎ¶¨Î•º Ìï†ÎãπÌï©ÎãàÎã§.\n// V2: Ïù¥ÎØ∏ Fan-out Î°úÏßÅÏù¥ Ï†ÅÏö©ÎêòÏñ¥ ÏûàÏúºÎÇò, ÌååÏùºÎ™Ö ÌÜµÏùºÏÑ±ÏùÑ ÏúÑÌï¥ V2Î°ú Ïù¥ÎèôÌï©ÎãàÎã§.\n\nconst items = $input.all();\nlet results = [];\n\nitems.forEach((item, itemIndex) => {\n    const data = item.json;\n\n    // top-level dialogue Ï∂îÏ∂ú\n    const dialogueEntries = data.dialogue || [];\n    const expressionId = data.id;\n\n    dialogueEntries.forEach((entry, lineIndex) => {\n        const rawText = entry.en || \"\";\n        const role = (entry.role || \"A\").toUpperCase();\n\n        // ÌÖçÏä§Ìä∏ Ï†ïÏ†ú\n        const cleanedText = rawText.replace(/\\n/g, \" \").replace(/\\s+/g, \" \").trim();\n\n        // Ïó≠Ìï†Î≥Ñ Î™©ÏÜåÎ¶¨ Ìï†Îãπ\n        const voice = role === \"B\" ? \"troy\" : \"hannah\";\n\n        results.push({\n            json: {\n                ...data, // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ\n                tts_input: cleanedText.substring(0, 200),\n                tts_voice: voice,\n                tts_line_index: lineIndex,\n                tts_model: \"canopylabs/orpheus-v1-english\",\n                tts_format: \"wav\",\n                tts_endpoint: \"https://api.groq.com/openai/v1/audio/speech\",\n                // Storage Ï†ÄÏû•ÏùÑ ÏúÑÌïú Í≤ΩÎ°ú ÌôïÏ†ï\n                storage_path: `expressions/${expressionId}/${lineIndex}.wav`,\n            },\n            pairedItem: { item: itemIndex },\n        });\n    });\n});\n\nreturn results;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2080,
                -304
            ],
            "id": "38c16dd4-ad74-4e0d-ab54-447f805cb347",
            "name": "Prepare TTS Requests"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://api.groq.com/openai/v1/audio/speech",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "model",
                            "value": "canopylabs/orpheus-v1-english"
                        },
                        {
                            "name": "input",
                            "value": "={{ $json.tts_input }}"
                        },
                        {
                            "name": "voice",
                            "value": "={{ $json.tts_voice }}"
                        },
                        {
                            "name": "response_format",
                            "value": "wav"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                2240,
                -544
            ],
            "id": "ac859aab-9f0d-4b37-b568-db7848ad6f6a",
            "name": "Groq Orpheus TTS",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "your-http-header-auth-id",
                    "name": "Groq Header Auth"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "=https://<YOUR_PROJECT_REF>.supabase.co/storage/v1/object/speak-mango-en/{{ $json.storage_path }}",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpHeaderAuth",
                "sendBody": true,
                "contentType": "binaryData",
                "inputDataFieldName": "data",
                "options": {
                    "response": {
                        "response": {
                            "responseFormat": "json"
                        }
                    }
                }
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.3,
            "position": [
                2416,
                -304
            ],
            "id": "1bd0a642-e4c2-4fcc-99d4-df1d61fa65c1",
            "name": "Upload to Storage",
            "credentials": {
                "httpHeaderAuth": {
                    "id": "your-http-header-auth-id",
                    "name": "Supabase Header Auth"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// 15. Aggregate TTS Results (V2 Fan-out Support)\n// TTS ÏôÑÎ£åÎêú Ïò§ÎîîÏò§ Ï°∞Í∞ÅÎì§ÏùÑ ÏõêÎ≥∏ ÏïÑÏù¥ÌÖúÎ≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ Ìï©Ïπ©ÎãàÎã§.\n// V2 Î≥ÄÍ≤ΩÏ†ê: Î™®Îì† Îì§Ïñ¥Ïò§Îäî ÏïÑÏù¥ÌÖúÏùÑ Paired Item(ÏõêÎ≥∏ ÌëúÌòÑÏãù) Í∏∞Ï§ÄÏúºÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ Î∞òÌôòÌï©ÎãàÎã§.\n\nconst items = $input.all();\nif (items.length === 0) return [];\n\n// 1. Prepare TTS RequestsÏùò ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞\nconst parentItems = $items(\"Prepare TTS Requests\");\n\n// 2. Í∑∏Î£πÌôî (Paired Item Index Í∏∞Ï§Ä)\nconst grouped = {};\n\nitems.forEach((item) => {\n    const pIdx = item.pairedItem.item; // ÏõêÎ≥∏ ÌëúÌòÑÏãùÏùò Ïù∏Îç±Ïä§\n\n    if (!grouped[pIdx]) {\n        // Ìï¥Îãπ Í∑∏Î£πÏù¥ Ï≤òÏùå Î∞úÍ≤¨ÎêòÎ©¥ Ï¥àÍ∏∞Ìôî\n        // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞(parentData)Î•º ÍπäÏùÄ Î≥µÏÇ¨ÌïòÏó¨ ÏãúÏûë\n        const parentData = parentItems[pIdx].json;\n        grouped[pIdx] = JSON.parse(JSON.stringify(parentData));\n\n        // Î∂àÌïÑÏöîÌïú ÏûÑÏãú ÌïÑÎìú Ï†úÍ±∞ (Ìïú Î≤àÎßå Ïã§Ìñâ)\n        Object.keys(grouped[pIdx]).forEach((key) => {\n            if (key.startsWith(\"tts_\") || key === \"storage_path\" || key === \"_validation\") {\n                delete grouped[pIdx][key];\n            }\n        });\n    }\n\n    // 3. Ïò§ÎîîÏò§ URL Ï£ºÏûÖ\n    const originalReq = parentItems[pIdx].json; // Ï£ºÏùò: pIdxÎäî Ï†ïÌôïÌïòÏßÄÎßå, Prepare TTS RequestsÍ∞Ä SplitÎêú ÏÉÅÌÉúÎùºÎ©¥?\n    // Prepare TTS RequestsÎäî N:NÏù¥ ÏïÑÎãàÎùº 1:N (Split) Í¥ÄÍ≥ÑÏûÑ.\n    // Îî∞ÎùºÏÑú item.pairedItem.itemÏùÄ \"Prepare TTS Requests\" ÎÖ∏ÎìúÏùò Ï∂úÎ†• ÏïÑÏù¥ÌÖú Ïù∏Îç±Ïä§Î•º Í∞ÄÎ¶¨ÌÇ¥.\n\n    // Ïó¨Í∏∞ÏÑú Î¨∏Ï†ú: \"Prepare TTS Requests\" ÏûêÏ≤¥Í∞Ä Ïù¥ÎØ∏ SplitÎêú ÏïÑÏù¥ÌÖúÎì§Ïù∏Í∞Ä?\n    // \"Prepare TTS Requests\" ÏΩîÎìúÎ•º Î≥¥Î©¥: items.forEach... results.push...\n    // Ï¶â, Prepare TTS RequestsÎäî \"SplitÎêú Í∞úÎ≥Ñ ÎùºÏù∏\"Îì§ÏùÑ Ï∂úÎ†•Ìï®.\n    // Îî∞ÎùºÏÑú aggregationÏùÑ ÏúÑÌï¥ÏÑúÎäî Í∑∏ *Ïù¥Ï†Ñ* Îã®Í≥ÑÏù∏ \"Generate ID\"Ïùò ÏïÑÏù¥ÌÖúÏúºÎ°ú Î¨∂Ïñ¥Ïïº Ìï®.\n    // ÌïòÏßÄÎßå Ïó¨Í∏∞ÏÑúÎäî Í∞ÑÎã®Ìûà \"Expression ID\" (id ÌïÑÎìú)Î°ú Î¨∂Îäî Í≤ÉÏù¥ Í∞ÄÏû• ÏïàÏ†ÑÌï®.\n\n    const expressionId = item.json.id; // Generate IDÏóêÏÑú ÏÉùÏÑ±Îêú UUID\n    // item.jsonÏóêÎäî ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú idÎ•º Î∞îÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•.\n});\n\n// Ïû¨ÏÑ§Í≥Ñ: Paired Item Ïù∏Îç±Ïä§Î≥¥Îã§ 'id' ÌïÑÎìúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Í∑∏Î£πÌôîÌïòÎäî Í≤ÉÏù¥ Ìõ®Ïî¨ ÏïàÏ†ÑÌï® (V2 Fan-out ÌôòÍ≤Ω)\nconst finalizedResults = {};\n\nitems.forEach((item) => {\n    const data = item.json;\n    const expressionId = data.id;\n\n    if (!finalizedResults[expressionId]) {\n        // Ï¥àÍ∏∞Ìôî: ÌòÑÏû¨ ÏïÑÏù¥ÌÖúÏùò Îç∞Ïù¥ÌÑ∞ÏóêÏÑú tts Í¥ÄÎ†® ÌïÑÎìúÎßå Ï†úÍ±∞ÌïòÍ≥† Î≥µÏÇ¨\n        const cleanData = JSON.parse(JSON.stringify(data));\n        Object.keys(cleanData).forEach(key => {\n            if (key.startsWith(\"tts_\") || key === \"storage_path\" || key === \"_validation\" || key === \"Key\") {\n                delete cleanData[key];\n            }\n        });\n        finalizedResults[expressionId] = cleanData;\n    }\n\n    // Ïò§ÎîîÏò§ Í≤ΩÎ°ú Ï∂îÏ∂ú\n    const originalReq = $items(\"Prepare TTS Requests\")[item.pairedItem.item].json;\n    const lineIndex = originalReq.tts_line_index;\n\n    let path = data.Key || originalReq.storage_path; // KeyÎäî Upload ÎÖ∏Îìú Ï∂úÎ†•, storage_pathÎäî fallback\n    if (path && path.startsWith(\"speak-mango-en/\")) {\n        path = path.replace(\"speak-mango-en/\", \"\");\n    }\n\n    // URL Ï£ºÏûÖ\n    if (finalizedResults[expressionId].dialogue && finalizedResults[expressionId].dialogue[lineIndex]) {\n        finalizedResults[expressionId].dialogue[lineIndex].audio_url = path;\n    }\n});\n\n// Í∞ùÏ≤¥Î•º Î∞∞Ïó¥Î°ú Î≥ÄÌôòÌïòÏó¨ Î∞òÌôò\nreturn Object.values(finalizedResults).map(json => ({ json }));"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2592,
                -304
            ],
            "id": "a0b8f4fd-07f2-4341-9ffa-db440fda6e56",
            "name": "Aggregate TTS Results"
        },
        {
            "parameters": {
                "jsCode": "/**\n * Relaxed Verification Logic for Gemini Output (V2)\n * Filters out invalid items instead of failing the entire workflow.\n * \n * Usage:\n * 1. Copy this code into the n8n Code node.\n * 2. Connect after 'Parse Content JSON'.\n * 3. Returns only VALID items to the next node. Invalid items are logged.\n */\n\nconst REGEX = {\n    hangul: /[\\uAC00-\\uD7AF\\u1100-\\u11FF\\u3130-\\u318F\\uA960-\\uA97F\\uD7B0-\\uD7FF]/,\n    kana: /[\\u3040-\\u309F\\u30A0-\\u30FF]/,\n    han: /[\\u4E00-\\u9FCC\\u3400-\\u4DB5]/,\n    cyrillic: /[\\u0400-\\u04FF]/,\n    arabic: /[\\u0600-\\u06FF\\u0750-\\u077F]/,\n    english_letters: /[a-zA-Z]/,\n    markdown_emphasis: /(\\*\\*|__|\\*|_)/\n};\n\nconst TARGET_LANGS = ['ko', 'ja', 'es', 'fr', 'de', 'ru', 'zh', 'ar'];\nconst ALLOWED_ENGLISH_TERMS = ['iPhone', 'eBay', 'iMac', 'iPad', 'iOS', 'macOS'];\n\nfunction validateItem(item) {\n    let errors = [];\n    if (!item.expression) errors.push(\"Missing 'expression' field.\");\n    if (!item.meaning) errors.push(\"Missing 'meaning' field.\");\n    if (!item.content) errors.push(\"Missing 'content' field.\");\n    if (!item.tags) errors.push(\"Missing 'tags' field.\");\n    if (!item.dialogue || !Array.isArray(item.dialogue)) errors.push(\"Missing 'dialogue' top-level array.\");\n\n    // Tags Validation\n    if (item.tags && Array.isArray(item.tags)) {\n        item.tags.forEach(tag => {\n            if (tag.includes('#')) errors.push(`Tag '${tag}' contains '#'.`);\n            if (tag !== tag.toLowerCase()) errors.push(`Tag '${tag}' must be lowercase.`);\n            if (!REGEX.english_letters.test(tag)) errors.push(`Tag '${tag}' must contain English letters.`);\n            if (REGEX.hangul.test(tag) || REGEX.kana.test(tag) || REGEX.cyrillic.test(tag) || REGEX.arabic.test(tag)) {\n                errors.push(`Tag '${tag}' must be English ONLY.`);\n            }\n        });\n    }\n\n    // Meaning Validation\n    if (item.meaning) {\n        TARGET_LANGS.forEach(lang => {\n            const text = item.meaning[lang];\n            if (!text) return;\n            if (lang === 'ko' && (REGEX.kana.test(text) || REGEX.han.test(text))) errors.push(`Meaning (${lang}) contains Mixed Foreign Script.`);\n            if (lang === 'ja' && REGEX.hangul.test(text)) errors.push(`Meaning (${lang}) contains Mixed Foreign Script (Hangul).`);\n            if (['ko', 'ja', 'zh', 'ru', 'ar'].includes(lang)) {\n                checkEnglishInclusion(text, `Meaning (${lang})`, errors);\n            }\n        });\n    }\n\n    // Content Validation\n    if (item.content) {\n        TARGET_LANGS.forEach(lang => {\n            const contentObj = item.content[lang];\n            if (!contentObj) return;\n\n            const fieldsToCheck = [\n                contentObj.situation,\n                contentObj.tip,\n                contentObj.quiz?.question,\n                contentObj.quiz?.A,\n                contentObj.quiz?.B,\n                contentObj.quiz?.C\n            ].filter(Boolean);\n\n            fieldsToCheck.forEach(text => {\n                if (lang === 'ko' && REGEX.kana.test(text)) errors.push(`Content (${lang}) contains Kana.`);\n                else if (lang === 'ja' && REGEX.hangul.test(text)) errors.push(`Content (${lang}) contains Hangul.`);\n                else if (['es', 'fr', 'de'].includes(lang)) {\n                    if (REGEX.hangul.test(text) || REGEX.kana.test(text) || REGEX.cyrillic.test(text) || REGEX.arabic.test(text)) {\n                        errors.push(`Content (${lang}) contains Mixed Foreign Script.`);\n                    }\n                }\n            });\n\n            if (contentObj.quiz && contentObj.quiz.answer) {\n                if (!['A', 'B', 'C'].includes(contentObj.quiz.answer)) {\n                    errors.push(`Quiz Answer (${lang}) must be 'A', 'B', or 'C'. Found: ${contentObj.quiz.answer}`);\n                }\n            }\n        });\n    }\n\n    // Dialogue Validation\n    if (item.dialogue && Array.isArray(item.dialogue)) {\n        item.dialogue.forEach((dItem, idx) => {\n            if (dItem.en) {\n                if (REGEX.hangul.test(dItem.en) || REGEX.kana.test(dItem.en)) {\n                    errors.push(`Dialogue[${idx}].en contains non-English characters.`);\n                }\n            }\n\n            if (dItem.translations) {\n                TARGET_LANGS.forEach(lang => {\n                    const text = dItem.translations[lang];\n                    if (!text) return;\n\n                    if (text.includes('**') || text.includes('__')) {\n                        errors.push(`Dialogue[${idx}].translations.${lang} contains Markdown Bold (**): \"${text}\"`);\n                    }\n\n                    if (['ko', 'ja', 'zh', 'ru', 'ar'].includes(lang)) {\n                        checkEnglishInclusion(text, `Dialogue[${idx}].translations.${lang}`, errors);\n                    } else {\n                        if (item.expression && text.toLowerCase().includes(item.expression.toLowerCase())) {\n                            if (item.expression.length > 4) {\n                                errors.push(`Dialogue[${idx}].translations.${lang} contains English expression leakage: \"${item.expression}\"`);\n                            }\n                        }\n                    }\n\n                    if (lang === 'ko' && (REGEX.kana.test(text) || REGEX.han.test(text))) errors.push(`Dialogue[${idx}].translations.${lang} contains foreign script.`);\n                    if (lang === 'ja' && REGEX.hangul.test(text)) errors.push(`Dialogue[${idx}].translations.${lang} contains Hangul.`);\n                });\n            }\n        });\n    }\n\n    return {\n        valid: errors.length === 0,\n        errors: errors\n    };\n}\n\nfunction checkEnglishInclusion(text, context, errors) {\n    const englishMatches = text.match(/[a-zA-Z]{2,}/g) || [];\n    const invalidWords = englishMatches.filter(word => {\n        if (ALLOWED_ENGLISH_TERMS.some(term => term.toLowerCase() === word.toLowerCase())) return false;\n        if (/^[A-Z]/.test(word)) return false;\n        return true;\n    });\n\n    if (invalidWords.length > 0) {\n        errors.push(`${context} contains English leakage: ${invalidWords.join(\", \")}`);\n    }\n}\n\n// Execution Block\nconst validItems = [];\nconst invalidItems = [];\n\nfor (const item of $input.all()) {\n    const dataToCheck = item.json;\n    const result = validateItem(dataToCheck);\n\n    if (result.valid) {\n        validItems.push({\n            json: item.json,\n            pairedItem: item.pairedItem\n        });\n    } else {\n        // Log errors to console (visible in n8n execution log)\n        console.log(`‚ö†Ô∏è Invalid Item Skipped [${dataToCheck.expression}]:`, result.errors);\n\n        invalidItems.push({\n            json: {\n                ...item.json,\n                _validationErrors: result.errors,\n                _validationStatus: \"error\"\n            },\n            pairedItem: item.pairedItem\n        });\n    }\n}\n\n// Optional: You could return specific output for invalid items on a second output branch\n// For now, we only return valid items to proceed with the workflow.\nif (validItems.length === 0 && invalidItems.length > 0) {\n    // If ALL failed, maybe we should throw or just return empty?\n    // User asked to \"skip failed items\", so returning empty array is technically correct behavior (stops workflow for those items).\n    console.log(\"‚ùå All items failed validation.\");\n}\n\nreturn validItems;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1760,
                -304
            ],
            "id": "800b49e0-1e3d-45e0-ac20-11246012ad9c",
            "name": "Validate Content"
        },
        {
            "parameters": {
                "jsCode": "// Prepare Prompt Data (Aggregation)\n// Get Existing ExpressionsÏùò Í≤∞Í≥º(Îã§Ï§ë ÏïÑÏù¥ÌÖú)Î•º \n// Pick CategoryÏùò ÏõêÎ≥∏ ÏïÑÏù¥ÌÖú(6Í∞ú) Í∏∞Ï§ÄÏúºÎ°ú Í∑∏Î£πÌôîÌï©ÎãàÎã§.\n\nconst categoryItems = $items(\"Pick Category\");\nconst existingItems = $input.all();\n\n// 1. Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú Í∏∞Î≥∏ Íµ¨Ï°∞ Ï¥àÍ∏∞Ìôî\nconst results = categoryItems.map(c => ({\n    ...c.json,\n    existing: []\n}));\n\n// Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏúºÎ°ú Ïù∏Îç±Ïä§Î•º Ï∞æÍ∏∞ ÏúÑÌïú Îßµ ÏÉùÏÑ±\nconst categoryMap = {};\ncategoryItems.forEach((c, index) => {\n    if (c.json.category) {\n        categoryMap[c.json.category] = index;\n    }\n});\n\n// 2. Í≤ÄÏÉâÎêú Í∏∞Ï°¥ ÌëúÌòÑÎì§ÏùÑ Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê Îß§Ìïë\nexistingItems.forEach(item => {\n    let targetIndex = -1;\n\n    // [ÏàòÏ†ïÎê®] Ïö∞ÏÑ†ÏàúÏúÑ Î≥ÄÍ≤Ω: Îç∞Ïù¥ÌÑ∞Ïùò ÎÇ¥Ïö©(category ÌïÑÎìú)ÏùÑ ÏµúÏö∞ÏÑ†ÏúºÎ°ú Ïã†Î¢∞Ìï©ÎãàÎã§.\n    // n8nÏùò pairedItemÏùÄ Ïã§Ìñâ ÌùêÎ¶ÑÏóê Îî∞Îùº Î∂ÄÏ†ïÌôïÌï† Ïàò ÏûàÏúºÎØÄÎ°ú(Mock Îç∞Ïù¥ÌÑ∞ÎÇò Pinned Data ÏÇ¨Ïö© Ïãú),\n    // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Ïóê Ï†ÅÌòÄÏûàÎäî Ïπ¥ÌÖåÍ≥†Î¶¨ Í∞íÏùÑ 1ÏàúÏúÑÎ°ú ÏÇ¨Ïö©Ìï©ÎãàÎã§.\n\n    // Ïö∞ÏÑ†ÏàúÏúÑ 1: ÏïÑÏù¥ÌÖú ÎÇ¥Î∂ÄÏùò 'category' ÌïÑÎìúÎ°ú Îß§Ìïë\n    if (item.json.category && categoryMap.hasOwnProperty(item.json.category)) {\n        targetIndex = categoryMap[item.json.category];\n    }\n    // Ïö∞ÏÑ†ÏàúÏúÑ 2: category ÌïÑÎìúÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ Ïª®ÌÖçÏä§Ìä∏(pairedItem) ÏÇ¨Ïö©\n    else if (item.pairedItem) {\n        targetIndex = item.pairedItem.item;\n    }\n\n    // Ïú†Ìö®Ìïú Ïù∏Îç±Ïä§Î•º Ï∞æÏïòÍ≥†, ÌëúÌòÑÏãùÏù¥ ÏûàÎã§Î©¥ Ï∂îÍ∞Ä\n    if (targetIndex !== -1 && results[targetIndex] && item.json.expression) {\n        results[targetIndex].existing.push(item.json.expression);\n    }\n});\n\n// 3. Ìè¨Îß∑ÌåÖÌïòÏó¨ Î∞òÌôò\nreturn results.map(r => ({\n    json: {\n        domain: r.domain,\n        category: r.category,\n        topic: r.topic,\n        existing_expressions_str: r.existing.length > 0 ? r.existing.join(\", \") : \"(None)\"\n    }\n}));"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -160,
                -320
            ],
            "id": "63af451a-32e8-4e39-83d3-c947c93d503c",
            "name": "Prepare Prompt Data"
        },
        {
            "parameters": {
                "mode": "combine",
                "combineBy": "combineByPosition",
                "options": {}
            },
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3.2,
            "position": [
                208,
                0
            ],
            "id": "cf10bb34-3cac-428b-9f7e-0884ca388aa0",
            "name": "Merge Context"
        },
        {
            "parameters": {
                "mode": "combine",
                "advanced": true,
                "mergeByFields": {
                    "values": [
                        {
                            "field1": "expression",
                            "field2": "expression"
                        }
                    ]
                },
                "joinMode": "enrichInput1",
                "options": {}
            },
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3.2,
            "position": [
                656,
                0
            ],
            "id": "56aa5338-cec4-4083-8179-c44e98618a6a",
            "name": "Merge Duplicate Status"
        },
        {
            "parameters": {
                "jsCode": "// 15. Groq TTS V2 (Batching & Rate Limit)\n// Groq APIÏùò 10 RPM Ï†úÌïúÏùÑ Ï§ÄÏàòÌïòÍ∏∞ ÏúÑÌï¥ 10Í∞úÏî© Î∞∞Ïπò Ï≤òÎ¶¨ÌïòÍ≥† 65Ï¥à ÎåÄÍ∏∞Ìï©ÎãàÎã§.\n// Î≥¥Ïïà: ÌôòÍ≤ΩÎ≥ÄÏàò(GROQ_API_KEY) ÎòêÎäî Credential('httpHeaderAuth')ÏùÑ ÏãúÎèÑÌï©ÎãàÎã§.\n\nconst items = $input.all();\nconst BATCH_SIZE = 10;\nconst WAIT_MS = 65000; // 65Ï¥à ÎåÄÍ∏∞\nconst results = [];\n\n// ÎåÄÍ∏∞ Ìï®Ïàò\nconst sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));\n\n// API Key Í∞ÄÏ†∏Ïò§Í∏∞ Ï†ÑÎûµ\n// 1. ÌôòÍ≤ΩÎ≥ÄÏàò ($env.GROQ_API_KEY) ÌôïÏù∏\n// 2. this.getCredentials ÏãúÎèÑ\n// 3. Ïã§Ìå® Ïãú ÏóêÎü¨\nlet apiKey;\n\n// Strategy 1: Environment Variable\n// Note: n8n sandbox might restrict access to process.env or $env, throwing an error.\ntry {\n    console.log(\"Debug: Starting API Key Check\");\n\n    if (typeof $env !== 'undefined') {\n        console.log(\"Debug: Keys in $env\", Object.keys($env));\n        if ($env.GROQ_API_KEY) {\n            console.log(\"Debug: Found GROQ_API_KEY in $env\");\n            apiKey = $env.GROQ_API_KEY;\n        }\n    }\n\n    if (!apiKey && typeof process !== 'undefined' && process.env) {\n        console.log(\"Debug: Keys in process.env\", Object.keys(process.env));\n        if (process.env.GROQ_API_KEY) {\n            console.log(\"Debug: Found GROQ_API_KEY in process.env\");\n            apiKey = process.env.GROQ_API_KEY;\n        }\n    }\n} catch (error) {\n    console.log(\"Environment variable access restricted: \" + error.message);\n}\n\n// Strategy 2: Credentials (Fallback)\nif (!apiKey) {\n    try {\n        let credentials;\n        if (typeof this.getCredentials === 'function') {\n            credentials = await this.getCredentials('httpHeaderAuth');\n        } else if (this.helpers && typeof this.helpers.getCredentials === 'function') {\n            credentials = await this.helpers.getCredentials('httpHeaderAuth');\n        }\n\n        if (credentials && credentials.value) {\n            apiKey = credentials.value;\n        }\n    } catch (e) {\n        // Credential Ï†ëÍ∑º Ïã§Ìå®Îäî Î¨¥ÏãúÌïòÍ≥† apiKey ÏóÜÏùåÏùÑ Ï≤¥ÌÅ¨\n        console.log(\"Credential access failed: \" + e.message);\n    }\n}\n\n// Final Check\nif (!apiKey) {\n    // ÏßÑÌñâ Î∂àÍ∞Ä\n    return items.map(item => ({\n        json: {\n            ...item.json,\n            error: `API Key Missing. Set GROQ_API_KEY in docker-compose.yml or connect 'Groq Header Auth' credential.`\n        },\n        pairedItem: item.pairedItem\n    }));\n}\n\n\n// Î∞∞Ïπò Ï≤òÎ¶¨ Î£®ÌîÑ\nfor (let i = 0; i < items.length; i += BATCH_SIZE) {\n    const batch = items.slice(i, i + BATCH_SIZE);\n\n    // Î≥ëÎ†¨ ÏöîÏ≤≠ Ï≤òÎ¶¨\n    const batchPromises = batch.map(async (item) => {\n        try {\n            // 1. ÏöîÏ≤≠ ÏòµÏÖò Íµ¨ÏÑ±\n            const options = {\n                method: 'POST',\n                uri: 'https://api.groq.com/openai/v1/audio/speech',\n                headers: {\n                    'Content-Type': 'application/json',\n                    'Authorization': `Bearer ${apiKey}`\n                },\n                body: JSON.stringify({\n                    model: 'canopylabs/orpheus-v1-english',\n                    input: item.json.tts_input,\n                    voice: item.json.tts_voice,\n                    response_format: 'wav'\n                }),\n                encoding: null // Ï§ëÏöî: Î∞îÏù¥ÎÑàÎ¶¨(Buffer)Î°ú Î∞õÏùå\n            };\n\n            // 2. ÏöîÏ≤≠ Ï†ÑÏÜ°\n            const response = await this.helpers.request(options);\n\n            // 3. ÏÑ±Í≥µ Ïãú Î∞îÏù¥ÎÑàÎ¶¨ Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®ÌïòÏó¨ Î∞òÌôò\n            return {\n                json: {\n                    ...item.json,\n                    status: \"success\"\n                },\n                binary: {\n                    data: {\n                        data: Buffer.from(response).toString('base64'),\n                        mimeType: 'audio/wav',\n                        fileName: `${item.json.id}_${item.json.tts_line_index}.wav`\n                    }\n                },\n                pairedItem: item.pairedItem\n            };\n\n        } catch (error) {\n            return {\n                json: {\n                    ...item.json,\n                    status: \"error\",\n                    error_message: error.message,\n                    error_stack: error.stack,\n                    error_response: error.response ? error.response.body : \"No response body\"\n                },\n                pairedItem: item.pairedItem\n            };\n        }\n    });\n\n    // ÌòÑÏû¨ Î∞∞ÏπòÏùò Î™®Îì† ÏöîÏ≤≠ ÏôÑÎ£å ÎåÄÍ∏∞\n    const batchResults = await Promise.all(batchPromises);\n    results.push(...batchResults);\n\n    // Îã§Ïùå Î∞∞ÏπòÍ∞Ä ÎÇ®ÏïÑÏûàÎã§Î©¥ ÎåÄÍ∏∞\n    if (i + BATCH_SIZE < items.length) {\n        await sleep(WAIT_MS);\n    }\n}\n\nreturn results;"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2240,
                -304
            ],
            "id": "40762de3-d115-4b38-9352-3c1e1794059f",
            "name": "Groq Orpheus TTS - Code",
            "alwaysOutputData": false
        },
        {
            "parameters": {
                "amount": 60
            },
            "type": "n8n-nodes-base.wait",
            "typeVersion": 1.1,
            "position": [
                1040,
                -304
            ],
            "id": "794c29c2-0a95-4762-b30c-1b6b9bebd49c",
            "name": "Wait",
            "webhookId": "a9cae0ab-b69e-40e1-a24f-0ec68f0927a6"
        }
    ],
    "pinData": {},
    "connections": {
        "Schedule Trigger": {
            "main": [
                [
                    {
                        "node": "Pick Category",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Google Gemini Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "Gemini Expression Generator",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Google Gemini Chat Model1": {
            "ai_languageModel": [
                [
                    {
                        "node": "Gemini Content Generator",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Pick Category": {
            "main": [
                [
                    {
                        "node": "Get Existing Expressions",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Gemini Expression Generator": {
            "main": [
                [
                    {
                        "node": "Merge Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Gemini Content Generator": {
            "main": [
                [
                    {
                        "node": "Parse Content JSON",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Check Duplicate": {
            "main": [
                [
                    {
                        "node": "Merge Duplicate Status",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "If New": {
            "main": [
                [
                    {
                        "node": "Wait",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Parse Expression JSON": {
            "main": [
                [
                    {
                        "node": "Check Duplicate",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Merge Duplicate Status",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Content JSON": {
            "main": [
                [
                    {
                        "node": "Validate Content",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Existing Expressions": {
            "main": [
                [
                    {
                        "node": "Prepare Prompt Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Generate ID": {
            "main": [
                [
                    {
                        "node": "Prepare TTS Requests",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare TTS Requests": {
            "main": [
                [
                    {
                        "node": "Groq Orpheus TTS - Code",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Groq Orpheus TTS": {
            "main": [
                []
            ]
        },
        "Upload to Storage": {
            "main": [
                [
                    {
                        "node": "Aggregate TTS Results",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Aggregate TTS Results": {
            "main": [
                [
                    {
                        "node": "Supabase Insert",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Validate Content": {
            "main": [
                [
                    {
                        "node": "Generate ID",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Prompt Data": {
            "main": [
                [
                    {
                        "node": "Gemini Expression Generator",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Merge Context",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Merge Context": {
            "main": [
                [
                    {
                        "node": "Parse Expression JSON",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Duplicate Status": {
            "main": [
                [
                    {
                        "node": "If New",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Groq Orpheus TTS - Code": {
            "main": [
                [
                    {
                        "node": "Upload to Storage",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Wait": {
            "main": [
                [
                    {
                        "node": "Gemini Content Generator",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1",
        "availableInMCP": false
    },
    "versionId": "your-version-id",
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "your-instance-id"
    },
    "id": "your-workflow-id",
    "tags": []
}